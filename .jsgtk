#!/usr/bin/env node

var
  child_process = require('child_process'),
  path = require('path'),
  executable = process.argv[1],
  gjsARGV = process.argv.slice(2),
  nodeModules = '',
  logError = function (err) {
    console.error(err.toString());
  },
  cwd = process.cwd()
;

if (!gjsARGV.length) process.exit(0);

process.on('uncaughtException', logError);

child_process.spawn('npm', ['config', 'get', 'prefix']).on('close', function () {
  var
    bin = path.join('', 'bin', ''),
    jsgtkModule = path.join(
      executable.slice(0, executable.lastIndexOf(bin)),
      'lib',
      'node_modules',
      'jsgtk'
    )
  ;
  child_process.spawn(
    'gjs', [
      '-I', jsgtkModule,
      '-I', path.join(nodeModules, 'lib'),
      '-c', ''.concat(
        ';imports.jsgtk.env;',
        ';process.cwd = () => ', JSON.stringify(cwd),
        ';require(', JSON.stringify(path.resolve(cwd, gjsARGV[0])), ')'
      )
    ].concat('jsgtk', gjsARGV),
    {
      stdio: [0, 0, 0]
    }
  )
    .on('error', logError)
    .on('close', function () {
      process.exit(0);
    })
    .on('exit', function (code) {
      process.exit(code);
    })
  }
).stdout.on('data', function (data) {
  nodeModules += data.toString();
});