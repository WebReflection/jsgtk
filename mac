# (C) Andrea Giammarchi @WebReflection
# the esiest way to install jsgtk is opening a terminal
# and writing the following command:
# sh -c "$(curl -fsSL https://webreflection.github.io/jsgtk/mac)"

pkgname=jsgtk

if [ "$TMPDIR" = "" ]; then
  TMPDIR=/tmp/
fi

# if specified, use $JSGTK_INSTALL folder
# e.g. export JSGTK_INSTALL_PATH=/opt/local
if [ "$JSGTK_INSTALL_PATH" != "" ]; then
  destdir="$JSGTK_INSTALL_PATH"
else
  if [ -d /usr/local/bin ]; then
    destdir=/usr/local
  else
    if [ -d /opt/local/bin ]; then
      destdir=/opt/local
    else
      echo ""
      echo " $(tput bold)[WARNING]$(tput sgr0): unable to locate a folder where to install jsgtk."
      echo "   Please run again this script after the following command:"
      echo " export JSGTK_INSTALL_PATH=~/.bin"
      echo ""
      exit 1
    fi
  fi
fi

destdirexe="${destdir}/bin/${pkgname}"
destdirlib="${destdir}/lib/${pkgname}"
pkgver=$(curl -sL https://webreflection.github.io/jsgtk/version)
pkgdir="${TMPDIR}${pkgname}-${pkgver}"
source="https://webreflection.github.io/jsgtk/archive/${pkgname}-${pkgver}.tar.gz"
macported='false'

# info message and ask for sudo
echo "

  $(tput bold)jsgtk ${pkgver}$(tput sgr0)

    jsgtk runs via $(tput bold)${destdirexe}$(tput sgr0)
    and uses its libraries in $(tput bold)${destdirlib}$(tput sgr0)

  sudo privilege is needed to install dependencies:

"
authorized=$(sudo sh -c "echo '${pkgver}'")
if [[ $? -ne 0 ]] || [[ "${authorized}" != "${pkgver}" ]]; then
  echo 'sudo password is necessary to install lib and exacutable'
  exit 1
fi

# verify dependencies
if [ "$(which gjs 2> /dev/null)" = "" ]; then
  if [ "$(which brew)" = "" ]; then
    if [ "$(which port)" = "" ]; then
      echo "  $(tput bold)Dependencies issue:$(tput sgr0)"
      echo '    please install either homebrew or macports to have GJS'
      echo '      http://brew.sh/'
      echo '      https://www.macports.org/ (suggested)'
      exit 0
    else
      macported='true'
      echo "  Installing $(tput bold)GJS$(tput sgr0) via $(tput bold)MacPorts$(tput sgr0)"
      sleep 2
      sudo port install gjs adwaita-icon-theme xorg-server xorg-xinit
    fi
  else
    echo "  Installing $(tput bold)GJS$(tput sgr0) via $(tput bold)Homebrew$(tput sgr0)"
    sleep 2
    brew install gtk+3 gjs adwaita-icon-theme
  fi
fi

# unpack and install the package
mkdir -p $pkgdir
cd $pkgdir
echo "installing from $(pwd)"
curl -sLO $source
tar -xzvf "${pkgname}-${pkgver}.tar.gz"
sudo mkdir -p "${destdirlib}"
sudo cp -r "${pkgname}/jsgtk_modules" "${destdirlib}"
sudo cp "${pkgname}/${pkgname}.sh" "${destdirexe}"
sudo chmod +x "${destdirexe}"
rm -rf $pkgdir

echo ""

# notify about MacPorts X11
if [ "${macported}" = "true" ]; then
  echo "  in order to use X11 please $(tput bold)log out$(tput sgr0)"
  echo "  and then $(tput bold)log in$(tput sgr0) again"
  echo ""
fi

echo "  $(tput bold)Thank you$(tput sgr0) for trying jsgtk!"
echo "  Following a usage example:"
echo ""
echo "jsgtk -e '
const Gtk = require(\"Gtk\");
Gtk.init(null);
const win = new Gtk.Window({
  title: \"jsgtk\",
  type: Gtk.WindowType.TOPLEVEL
})
  .once(\"show\", Gtk.main)
  .on(\"destroy\", Gtk.mainQuit);
win.add(new Gtk.Label({label: \"Hello jsGtk+\"}));
win.setDefaultSize(200, 80);
win.showAll();
'"
echo ""